{% extends 'base.html' %}

{% block title %}Resultado - Derivaci√≥n Num√©rica{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <div class="max-w-6xl mx-auto">
        <!-- Header -->
        <div class="mb-8">
            <h1 class="text-3xl font-bold text-gray-800 mb-2">Derivaci√≥n Num√©rica - Resultados</h1>
            <p class="text-gray-600">M√©todo: {{ result.metodo|title }}</p>
        </div>

        <!-- Wizard Steps Indicator -->
        <div class="mb-8">
            <div class="flex items-center space-x-4">
                <div class="flex items-center text-green-600">
                    <div class="w-8 h-8 bg-green-600 text-white rounded-full flex items-center justify-center text-sm font-medium">‚úì</div>
                    <span class="ml-2 text-sm font-medium">Ingreso de datos</span>
                </div>
                <div class="flex-1 h-0.5 bg-green-600"></div>
                <div class="flex items-center text-green-600">
                    <div class="w-8 h-8 bg-green-600 text-white rounded-full flex items-center justify-center text-sm font-medium">‚úì</div>
                    <span class="ml-2 text-sm font-medium">Selecci√≥n de m√©todo</span>
                </div>
                <div class="flex-1 h-0.5 bg-green-600"></div>
                <div class="flex items-center text-green-600">
                    <div class="w-8 h-8 bg-green-600 text-white rounded-full flex items-center justify-center text-sm font-medium">3</div>
                    <span class="ml-2 text-sm font-medium">Resultados</span>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <!-- Resumen y Resultado -->
            <div class="space-y-6">
                <!-- Datos de Entrada -->
                <div class="bg-white rounded-lg shadow-lg p-6">
                    <h2 class="text-xl font-semibold text-gray-800 mb-4">Datos de Entrada</h2>
                    <div class="space-y-3">
                        <div class="flex justify-between">
                            <span class="text-gray-600">Funci√≥n:</span>
                            <code class="bg-gray-100 px-2 py-1 rounded">f(x) = {{ result.entrada.function }}</code>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Punto x‚ÇÄ:</span>
                            <span class="font-mono">{{ result.entrada.x0 }}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Paso h:</span>
                            <span class="font-mono">{{ result.entrada.h }}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">M√©todo:</span>
                            <span class="capitalize">{{ result.metodo|title }}</span>
                        </div>
                    </div>
                </div>

                <!-- Resultado Final -->
                <div class="bg-indigo-50 border-2 border-indigo-200 rounded-lg p-6">
                    <h2 class="text-xl font-semibold text-indigo-800 mb-4">Resultado Final</h2>
                    <div class="text-center">
                        {% if result.metodo in 'second_derivative,five_point' %}
                        <div class="text-3xl font-bold text-indigo-600 mb-2">
                            f''({{ result.entrada.x0 }}) ‚âà {{ result.valor|floatformat:6 }}
                        </div>
                        {% else %}
                        <div class="text-3xl font-bold text-indigo-600 mb-2">
                            f'({{ result.entrada.x0 }}) ‚âà {{ result.valor|floatformat:6 }}
                        </div>
                        {% endif %}
                        
                        <!-- Informaci√≥n de Error Mejorada -->
                        {% if result.detalles.error_info %}
                        <div class="mt-4 space-y-2">
                            {% if result.detalles.error_info.tipo %}
                            <div class="text-sm font-medium text-indigo-700">
                                {{ result.detalles.error_info.tipo }}
                            </div>
                            {% endif %}
                            
                            {% if result.detalles.error_info.exact_value %}
                            <div class="text-sm text-indigo-600">
                                Valor exacto: {{ result.detalles.error_info.exact_value|floatformat:8 }}
                            </div>
                            {% endif %}
                            
                            {% if result.detalles.error_info.absolute_error %}
                            <div class="text-sm text-indigo-600">
                                Error absoluto: {{ result.detalles.error_info.absolute_error|floatformat:8 }}
                            </div>
                            {% endif %}
                            
                            {% if result.detalles.error_info.relative_error and result.detalles.error_info.relative_error != 'inf' %}
                            <div class="text-sm text-indigo-600">
                                Error relativo: {{ result.detalles.error_info.relative_error|floatformat:6 }}%
                            </div>
                            {% endif %}
                            
                            {% if result.detalles.error_info.curvature_error %}
                            <div class="text-sm text-indigo-600">
                                Error de curvatura: {{ result.detalles.error_info.curvature_error|floatformat:8 }}
                            </div>
                            {% endif %}
                        </div>
                        {% elif result.error %}
                        <div class="text-sm text-indigo-600">
                            Error estimado: {{ result.error|floatformat:8 }}
                        </div>
                        {% endif %}
                    </div>
                </div>

                <!-- Pasos del C√°lculo -->
                <div class="bg-white rounded-lg shadow-lg p-6">
                    <h2 class="text-xl font-semibold text-gray-800 mb-4">Pasos del C√°lculo</h2>
                    <div class="space-y-3">
                        {% for paso in result.pasos %}
                        <div class="border-l-4 border-indigo-200 pl-4">
                            <h4 class="font-medium text-gray-800">{{ paso.descripcion }}</h4>
                            <code class="text-sm text-gray-600 bg-gray-50 p-2 rounded block mt-1">{{ paso.calculo }}</code>
                        </div>
                        {% endfor %}
                    </div>
                </div>

                <!-- Exportaci√≥n -->
                <div class="bg-white rounded-lg shadow-lg p-6">
                    <h2 class="text-xl font-semibold text-gray-800 mb-4">Exportar Resultados</h2>
                    <div class="flex space-x-4">
                        <button onclick="exportTXT()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded">
                            üìÑ Descargar TXT
                        </button>
                        <button onclick="exportPDF()" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded">
                            üìë Descargar PDF
                        </button>
                    </div>
                </div>
            </div>

            <!-- Gr√°fico -->
            <div class="space-y-6">
                {% if result.grafico_path %}
                <div class="bg-white rounded-lg shadow-lg p-6">
                    <h2 class="text-xl font-semibold text-gray-800 mb-4">Visualizaci√≥n Gr√°fica</h2>
                    <div class="text-center">
                        <img src="/static/{{ result.grafico_path }}" alt="Gr√°fico de derivaci√≥n num√©rica" class="max-w-full h-auto mx-auto rounded">
                    </div>
                    <p class="text-sm text-gray-600 mt-2 text-center">
                        Representaci√≥n gr√°fica del m√©todo {{ result.metodo|title }}
                    </p>
                </div>
                {% endif %}

                <!-- Informaci√≥n del M√©todo -->
                <div class="bg-white rounded-lg shadow-lg p-6">
                    <h2 class="text-xl font-semibold text-gray-800 mb-4">Informaci√≥n del M√©todo</h2>
                    {% if result.metodo == 'forward' %}
                    <div class="space-y-2">
                        <p><strong>Diferencia hacia adelante:</strong></p>
                        <p class="text-sm text-gray-600">f'(x‚ÇÄ) ‚âà (f(x‚ÇÄ+h) - f(x‚ÇÄ))/h</p>
                        <p class="text-sm text-gray-600">Error de truncamiento: O(h)</p>
                        <p class="text-sm text-amber-600">‚ö† M√©todo de primer orden</p>
                    </div>
                    {% elif result.metodo == 'backward' %}
                    <div class="space-y-2">
                        <p><strong>Diferencia hacia atr√°s:</strong></p>
                        <p class="text-sm text-gray-600">f'(x‚ÇÄ) ‚âà (f(x‚ÇÄ) - f(x‚ÇÄ-h))/h</p>
                        <p class="text-sm text-gray-600">Error de truncamiento: O(h)</p>
                        <p class="text-sm text-amber-600">‚ö† M√©todo de primer orden</p>
                    </div>
                    {% elif result.metodo == 'central' %}
                    <div class="space-y-2">
                        <p><strong>Diferencia central:</strong></p>
                        <p class="text-sm text-gray-600">f'(x‚ÇÄ) ‚âà (f(x‚ÇÄ+h) - f(x‚ÇÄ-h))/(2h)</p>
                        <p class="text-sm text-gray-600">Error de truncamiento: O(h¬≤)</p>
                        <p class="text-sm text-green-600">‚úì M√©todo de segundo orden - M√°s preciso</p>
                    </div>
                    {% elif result.metodo == 'second_derivative' %}
                    <div class="space-y-2">
                        <p><strong>Segunda derivada central:</strong></p>
                        <p class="text-sm text-gray-600">f''(x‚ÇÄ) ‚âà (f(x‚ÇÄ+h) - 2f(x‚ÇÄ) + f(x‚ÇÄ-h))/h¬≤</p>
                        <p class="text-sm text-gray-600">Error de truncamiento: O(h¬≤)</p>
                        <p class="text-sm text-blue-600">üìà Calcula la curvatura de la funci√≥n</p>
                    </div>
                    {% elif result.metodo == 'five_point' %}
                    <div class="space-y-2">
                        <p><strong>Segunda derivada 5 puntos:</strong></p>
                        <p class="text-sm text-gray-600">f''(x‚ÇÄ) ‚âà (-f(x‚ÇÄ-2h) + 16f(x‚ÇÄ-h) - 30f(x‚ÇÄ) + 16f(x‚ÇÄ+h) - f(x‚ÇÄ+2h))/(12h¬≤)</p>
                        <p class="text-sm text-gray-600">Error de truncamiento: O(h‚Å¥)</p>
                        <p class="text-sm text-green-600">‚úì M√©todo de alta precisi√≥n para segunda derivada</p>
                    </div>
                    {% elif result.metodo == 'richardson' %}
                    <div class="space-y-2">
                        <p><strong>Extrapolaci√≥n de Richardson:</strong></p>
                        <p class="text-sm text-gray-600">R = (4¬∑D(h/2) - D(h))/3</p>
                        <p class="text-sm text-gray-600">Error de truncamiento: O(h‚Å¥)</p>
                        <p class="text-sm text-green-600">‚úì Combina m√∫ltiples approximaciones para mayor precisi√≥n</p>
                        <p class="text-sm text-blue-600">üî¨ Elimina el t√©rmino dominante del error</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Botones de Navegaci√≥n -->
        <div class="mt-8 flex justify-between">
            <a href="{% url 'derivacion_form' %}" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded">
                ‚Üê Nueva Derivada
            </a>
            <a href="{% url 'index' %}" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded">
                Volver al Men√∫ Principal
            </a>
        </div>
    </div>
</div>

<script>
function exportTXT() {
    const content = `DERIVACI√ìN NUM√âRICA - RESULTADOS
=====================================

Funci√≥n: f(x) = {{ result.entrada.function }}
Punto: x‚ÇÄ = {{ result.entrada.x0 }}
Paso: h = {{ result.entrada.h }}
M√©todo: {{ result.metodo|title }}

RESULTADO FINAL:
f'({{ result.entrada.x0 }}) ‚âà {{ result.valor|floatformat:8 }}
{% if result.error %}Error estimado: {{ result.error|floatformat:8 }}{% endif %}

PASOS DEL C√ÅLCULO:
{% for paso in result.pasos %}{{ forloop.counter }}. {{ paso.descripcion }}
   {{ paso.calculo }}
{% endfor %}

Generado el: {{ "now"|date:"d/m/Y H:i:s" }}
`;

    const blob = new Blob([content], { type: 'text/plain' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'derivacion_numerica_{{ result.metodo }}.txt';
    document.body.appendChild(a);
    a.click();
    window.URL.revokeObjectURL(url);
    document.body.removeChild(a);
}

function exportPDF() {
    // Implementar exportaci√≥n PDF usando el endpoint del servidor
    window.open('/pdf/derivacion_{{ result.metodo }}_resultado.pdf', '_blank');
}
</script>
{% endblock %} 